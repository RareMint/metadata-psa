"use strict";angular.module("CCG.PopReport").controller("populationReportController",["$scope","populationReportService","seoService",function(n,t,i){var r=this;r.isLoading=!0;r.errorType=undefined;t.getLastUpdate().then(function(n){r.lastUpdate=n.updateTime});r.getImageUrl=function(n,t,i){return _.isEmpty(t)?i:(n+t).trim()};n.$on("popReport.loaded",function(){r.isLoading=!1});n.$on("popReport.error",function(n,t){r.errorType=t;t.status===404&&i.setTitle("Page Not Found");console.log(t)});n.$on("popReport.breadcrumbUrls",function(n,t){r.breadcrumbUrls=t});n.$on("popReport.stickyHeaderData",function(n,t){r.stickyHeaderData=t})}]);angular.module("CCG.PopReport").controller("populationReportCategoriesController",["$scope","populationReportService","seoService",function(n,t,i){var r=this;i.setCanonicalUrl("/population-report/");t.fetchAllCategories().then(function(n){r.categories=n}).catch(function(t){n.$emit("popReport.error",t)}).finally(function(){n.$emit("popReport.loaded")})}]);angular.module("CCG.PopReport").controller("populationReportSubcategoriesController",["$q","$scope","urlService","populationReportService","seoService",function(n,t,i,r,u){var f=this,e=parseInt(i.pathParts()[2]);n.all([r.getCategory(e),r.fetchSubcategories(e),]).then(function(n){if(f.category=n[0],f.subcategories=n[1],f.subcategories.length===0)throw{status:404};var t="/population-report/"+f.category.seoName+"/"+f.category.researchCategoryID+"/";i.baseUrl!==t&&i.replaceUrl(t);u.setTitle(f.category.name+" Cards");u.setMetaDescription(f.category.metaDescription);u.setCanonicalUrl(t)}).catch(function(n){t.$emit("popReport.error",n)}).finally(function(){t.$emit("popReport.loaded")})}]);angular.module("CCG.PopReport").controller("populationReportGroupsController",["$q","$location","$scope","$timeout","urlService","populationReportService","seoService",function(n,t,i,r,u,f,e){var o=this,h=u.baseUrl,c=parseInt(u.pathParts()[2])||0,s=parseInt(u.pathParts()[4])||0;o.page=t.search().page||1;o.loading=!0;o.searchText="";n.all([f.getCategory(c),f.getSubcategory(s),f.fetchGroups(s,o.page,o.searchText,""),f.fetchLanguages(s),]).then(function(n){if(o.category=n[0],o.subcategory=n[1],o.originalGroups=n[2],o.groups=n[2],o.languages=n[3],o.subcategory.researchCategoryID!==o.category.researchCategoryID)throw{status:404};var t="/population-report/"+o.category.seoName+"/"+o.category.researchCategoryID+"/"+o.subcategory.seoName+"/"+o.subcategory.researchSubcategoryID+"/";u.baseUrl!==t&&(u.updateUrl(t),h=t);e.setTitle(o.subcategory.name+" "+o.category.name+" Cards");e.setMetaDescription(o.subcategory.metaDescription);e.setCanonicalUrl(t,["page"])}).catch(function(n){i.$emit("popReport.error",n)}).finally(function(){i.$emit("popReport.loaded")});o.changePage=function(n){u.replaceUrl(h,{page:n});o.page=n;f.fetchGroups(s,n,o.searchText,o.selectedLanguage).then(function(n){o.groups=n}).catch(console.error)};o.searchGroups=function(n){r(function(){if((o.searchText===undefined||!o.searchText.length)&&!n){o.prevSearchString=o.searchText.trim();o.groups=o.originalGroups;u.replaceUrl(h,{page:o.page});return}(o.searchText.trim()!==o.prevSearchString||n)&&(o.prevSearchString=o.searchText.trim(),f.fetchGroups(s,1,o.searchText,o.selectedLanguage).then(function(n){o.groups=n;u.replaceUrl(h,{page:o.groups.Page})}).catch(function(n){console.error(n);o.groups=o.originalGroups}))},100)}}]);angular.module("CCG.PopReport").controller("populationReportCardsController",["$timeout","$q","$location","$element","$interval","$scope","urlService","populationReportGrades","populationReportService","seoService",function(n,t,i,r,u,f,e,o,s,h){function y(){return s.fetchPopulation(k,c.page,c.searchText,c.showBaseOnly,c.populationID)}function a(){n(function(){var n=[],t=0;$(".ccg-data-table").each(function(i){t=i;$("tr > :first-child",this).each(function(i){var r=$(this).outerHeight();t===0?n[i]=[r]:n[i].push(r)})});$.each(n,function(n,t){var i=n,r=Math.max(t[0],t[1]);$(".ccg-data-table").each(function(){$("tr:eq("+i+") > :first-child",this).outerHeight(r)})})},100)}function nt(){angular.element(function(){!c.populationID||c.populationID===undefined||document.getElementById(c.populationID)===null?$("th").length>24&&f.$emit("gridStickyHeader.hide.main"):n(function(){const n=document.getElementById(c.populationID).getBoundingClientRect().top,t=n-$(".sticky-header").height()-$(".ccg-data-table__title").height()-$("#"+c.populationID).height();window.scrollBy({top:t,behavior:"smooth"})},500)})}function ut(){var n=0;$.each(c.population.Items,function(t){n+=c.population.Items[t].population_Total>0?1:0});c.disableOnlyGraded=n===0}function ft(n,t){var i="",r="";return isNaN(n.trim())?(i=n.trim(),r=t.trim()):(r=n.trim(),i=t.trim()),{descriptor:i,grade:r}}function et(){f.$emit("popReport.stickyHeaderData",{name:c.group.name,description:c.group.description});var n="/population-report/"+c.category.seoName+"/"+c.category.researchCategoryID+"/",t=n+c.subcategory.seoName+"/"+c.subcategory.researchSubcategoryID+"/";f.$emit("popReport.breadcrumbUrls",[{name:c.category.name,url:n},{name:c.subcategory.name,url:t},])}var c=this,l=e.baseUrl,tt=parseInt(e.pathParts()[2])||0,it=parseInt(e.pathParts()[4])||0,k=parseInt(e.pathParts()[6])||0,rt=i.search().populationID||undefined,p="",d=1,w,g,b,v;c.page=i.search().page||1;c.populationID=i.search().populationID||undefined;c.searchText="";c.showBaseOnly=!1;c.gradeHeaders=o.getGradeColumns();c.auctionSrc=o.getAuctionSource();t.all([s.getCategory(tt),s.getSubcategory(it),s.getGroup(k),y(),]).then(function(n){if(c.category=n[0],c.subcategory=n[1],c.group=n[2],c.population=n[3],c.originalPopulation=c.population,c.group.researchSubcategoryID!==c.subcategory.researchSubcategoryID||c.subcategory.researchCategoryID!==c.category.researchCategoryID||c.population.Items.length===0)throw{status:404};c.populationID!==undefined&&(c.populationID=parseInt(c.populationID),p="?populationID="+c.populationID);var t="/population-report/"+c.category.seoName+"/"+c.category.researchCategoryID+"/"+c.subcategory.seoName+"/"+c.subcategory.researchSubcategoryID+"/"+c.group.seoName+"/"+c.group.researchGroupID+"/"+p;e.baseUrl!==t&&(e.updateUrl(t),l=t);c.page=c.population.Page;d=c.population.Page;e.replaceUrl(l,{page:c.population.Page});c.createHighlightEvents();f.$emit("gridStickyHeader.reload.main");et();h.setTitle(c.group.name+" Cards");h.setMetaDescription(c.group.metaDescription);h.setCanonicalUrl(t,["page"]);a();nt();ut()}).catch(function(n){f.$emit("popReport.error",n)}).finally(function(){f.$emit("popReport.loaded")});c.changePage=function(n){var t="";n!==d?c.populationID=undefined:(c.populationID=rt,t=p);e.replaceUrl(l+t,{page:n});c.page=n;y().then(function(n){c.population=n;f.$emit("gridStickyHeader.reload.main");a();nt()}).catch(console.error)};c.searchCards=function(t){n(function(){if((c.searchText===undefined||!c.searchText.length)&&!t){c.population=c.originalPopulation;e.replaceUrl(l,{page:c.page});a();return}(c.searchText.trim()!==c.prevSearchString||t)&&(c.prevSearchString=c.searchText.trim(),c.page=1,y().then(function(n){c.population=n;e.replaceUrl(l,{page:c.population.Page});f.$emit("gridStickyHeader.reload.main");a()}).catch(function(n){console.log(n);c.population=c.originalPopulation}))},100)};c.filterCards=function(n){c.showBaseOnly=n;c.page=1;y().then(function(n){c.population=n;e.replaceUrl(l,{page:c.population.Page});f.$emit("gridStickyHeader.reload.main");a()}).catch(function(n){console.log(n);c.population=c.originalPopulation})};$(window).resize(function(){a()});c.getColumnValue=function(n,t){if(n!==undefined)return t[n.column]};c.getSubgradeUrl=function(n,t,i,r,u){var h=c.getColumnValue(u,r),f,e,o,s;return h<=0?"":(f="",e=u.display,u.display.includes(" ")&&(o=u.display.split(" "),s=ft(o[0],o[1]),f="&descriptor="+s.descriptor,e=s.grade),"/population-report/"+n.seoName+"/"+n.researchCategoryID+"/"+t.seoName+"/"+t.researchSubcategoryID+"/"+i.seoName+"/"+i.researchGroupID+"/"+r.populationID+"/sub-grades/?grade="+e+f)};c.getGroupEbayUrl=function(){return"/resources/services/auctions/population-set/?setName="+encodeURIComponent(c.group.name)+"&src="+c.auctionSrc};c.createHighlightEvents=function(){r.on("mouseenter",".scrollable td",function(){c.highlightCell($(this),"focused highlight")});r.on("mouseleave",function(){g||u.cancel(w)})};c.highlightCell=function(n,t){g||n.attr("class")!==undefined&&n.attr("class").indexOf("ccg-data-table__title")>=0||(u.cancel(w),w=u(function(){b&&b.removeClass(t);var i=n.index();_.isNil(v)||i===v||c.highlightColumn(n,v,"removeClass");c.highlightColumn(n,i,"addClass","highlight",t);n.addClass(t);v=i;b=n},c.highlightDelay||0,1))};c.highlightColumn=function(n,t,i,r,u){var f=n.closest("table").find("td:nth-child("+(t+1)+")"),e=n.closest("table").find("th:nth-child("+(t+1)+")"),o=$(".pinned-header-wrap.scrollable table").find("th:nth-child("+(t+1)+")");c.clearHighlightColumn(r);c.clearHighlightColumn(u);c.clearHighlightColumn(r);f.each(function(){($(this).attr("class")===undefined||$(this).attr("class").indexOf("ccg-data-table__title")===-1)&&$(this).toggleClass(r,i==="addClass")});e.each(function(){$(this).toggleClass(r,i==="addClass")});o.each(function(){$(this).toggleClass(r,i==="addClass")})};c.clearHighlightColumn=function(n){var t=r.find("td, th");t.each(function(){$(this).removeClass(n)})}}]);angular.module("CCG.PopReport").controller("populationReportSubgradeController",["$q","$location","$scope","$timeout","urlService","populationReportGrades","populationReportService","seoService",function(n,t,i,r,u,f,e,o){function v(){var t="",n;s.descriptor!==""&&(t="&descriptor="+s.descriptor);n="/population-report/"+s.category.seoName+"/"+s.category.researchCategoryID+"/"+s.subcategory.seoName+"/"+s.subcategory.researchSubcategoryID+"/"+s.group.seoName+"/"+s.group.researchGroupID+"/"+h+"/sub-grades/?grade="+s.grade+t;u.baseUrl!==n&&(u.replaceUrl(n),u.baseUrl=n);var i="Grade "+s.fullGrade,r=s.cardNumberPrefix+(s.population.cardNumber||""),f=s.population.variant||"",e=s.population.description||"",c=i+" "+r+" "+s.population.name+" "+f+" "+e+" Sub-Grades";o.setTitle(c.replace(/\s\s+/g," "));o.setMetaDescription(s.subgrades[0].metaDescription);o.setCanonicalUrl(n,["grade","descriptor"])}var s=this,c=parseInt(u.pathParts()[2])||0,l=parseInt(u.pathParts()[4])||0,a=parseInt(u.pathParts()[6])||0,h=u.pathParts()[7]||"0";s.descriptor=t.search().descriptor||"";s.grade=t.search().grade||0;s.fullGrade=s.grade;s.loading=!0;s.columns=f.getGradeColumns();s.headers=f.getSubgradeColumns(_.includes(["9.5","9","8.5"],s.grade));s.src=f.getAuctionSource();s.colspan=s.headers.length-1;s.descriptor!==undefined&&s.descriptor!==""&&(s.fullGrade=s.descriptor+" "+s.grade);n.all([e.getCategory(c),e.getSubcategory(l),e.getGroup(a),e.getCard(h),e.fetchSubgrades(h,s.grade,s.descriptor),]).then(function(n){var i,r,t;if(s.loading=!1,s.category=n[0],s.subcategory=n[1],s.group=n[2],s.population=n[3],s.subgrades=n[4],s.cardNumberPrefix=s.population.cardNumber.trim()!==""&&s.population.cardNumber!==undefined?"#":"",s.totalGraded=_.sumBy(s.subgrades,"populationCount"),s.population.researchGroupID!==s.group.researchGroupID||s.group.researchSubcategoryID!==s.subcategory.researchSubcategoryID||s.subcategory.researchCategoryID!==s.category.researchCategoryID)throw{status:404};s.cardsWithHigherGrade=0;i=_(s.columns).filter({display:s.fullGrade}).map("column").first();for(r in s.columns)if(t=s.columns[r].column,t===i)break;else t!=="population_Total"&&(s.cardsWithHigherGrade+=s.population[t]);v();s.updateSorting()}).catch(function(n){i.$emit("popReport.error",n)}).finally(function(){i.$emit("popReport.loaded")});s.getSortClass=function(n){var t="";return n.display===s.sortColumn&&(t=s.sortDescending?"down-arrow-alt":"up-arrow-alt"),t};s.updateSorting=function(n){function u(t){return n?n.display===t.display?0:1:0}var t=_(s.headers).filter("sortOrder").orderBy([u,"sortOrder"],["asc","asc"]).value(),i,r;n&&n.display===s.sortColumn?s.sortDescending=!s.sortDescending:(s.sortDescending=!0,s.sortColumn=t[0].display);i=t.map(function(n){return n.customSort||n.column});r=t.map(function(){return s.sortDescending?"desc":"asc"});s.subgrades=_.orderBy(s.subgrades,i,r)};s.truncateNumbers=function(n){return parseFloat(n)||n}}]);angular.module("CCG.PopReport").controller("populationReportSearchController",["$q","populationReportService",function(n,t){var i=this,r="#search_typeahead";i.searchPromise=n.resolve([]);i.searchCards=function(n){if(n.length)return n.trim()!==i.prevSearchString&&(i.prevSearchString=n.trim(),i.searchPromise=t.searchCard(n).catch(function(n){return console.log(n),[]})),i.searchPromise};i.cardSelected=function(n){n&&(n=n.originalObject,n)&&(window.location="/population-report/"+n.group.subcategory.category.seoName+"/"+n.group.subcategory.category.researchCategoryID+"/"+n.group.subcategory.seoName+"/"+n.group.subcategory.researchSubcategoryID+"/"+n.group.seoName+"/"+n.group.researchGroupID+"/?populationID="+n.populationID)};i.focusIn=function(){var t=angular.element(r),n=$.Event("keyup");n.which=40;t.trigger(n)}}]);angular.module("CCG.PopReport").provider("populationReportGrades",[function(){var n=this;this.baseGradeColumns=[];this.baseSubgradeColumns=[];this.baseAuctionSource="";this.setGradeColumns=function(t){n.baseGradeColumns=t};this.setSubgradeColumns=function(t){n.baseSubgradeColumns=t};this.setAuctionSource=function(t){n.baseAuctionSource=t};this.$get=[function(){return{getGradeColumns:function(){return n.baseGradeColumns},getSubgradeColumns:function(t){var i=n.baseSubgradeColumns;return t||(i=n.baseSubgradeColumns.filter(function(n){return!n.optional})),i},getAuctionSource:function(){return n.baseAuctionSource}}}]}]);angular.module("CCG.PopReport").factory("populationReportService",["apiServiceFactory",function(n){return n.create({getLastUpdate:function(){return this.get("/research/population/update-time/")},fetchAllCategories:function(){return this.get("/research/categories/")},getCategory:function(n){return this.get("/research/categories/"+n+"/")},fetchSubcategories:function(n){return this.get("/research/subcategories/?researchCategoryID="+n)},getSubcategory:function(n){return this.get("/research/subcategories/"+n+"/")},fetchGroups:function(n,t,i,r){return(t===undefined||isNaN(t))&&(t=1),r===undefined&&(r=""),i===undefined&&(i=""),this.get("/research/groups/?researchSubcategoryID="+n+"&page="+t+"&keywords="+encodeURIComponent(i)+"&languageName="+r)},getGroup:function(n){return this.get("/research/groups/"+n+"/")},fetchPopulation:function(n,t,i,r,u){return(t===undefined||isNaN(t))&&(t=1),u===undefined&&(u=""),this.get("/research/population/?researchGroupID="+n+"&page="+t+"&keywords="+encodeURIComponent(i)+"&baseOnly="+r+"&populationID="+u)},getCard:function(n){return this.get("/research/population/"+n+"/")},getCardByCollectibleID:function(n){return this.get("/research/population/collectible/"+n+"/")},fetchSubgrades:function(n,t,i){return this.get("/research/subgrades/?populationID="+n+"&grade="+t+"&descriptor="+i)},searchCard:function(n){return this.get("/research/population/search/?keywords="+encodeURIComponent(n))},fetchLanguages:function(n){return this.getLocalVariable("fetchLanguages")?this.get("/research/languages/?researchSubcategoryID="+n):undefined}})}]);angular.module("CCG.PopReport").config(["populationReportGradesProvider",function(n){n.setAuctionSource("CGCPopReport");n.setGradeColumns([{display:"Perfect 10",column:"population_Perfect10"},{display:"Pristine 10",column:"population_Pristine10"},{display:"9.5",column:"population_9_5"},{display:"9",column:"population_9_0"},{display:"8.5",column:"population_8_5"},{display:"8",column:"population_8_0"},{display:"7.5",column:"population_7_5"},{display:"7",column:"population_7_0"},{display:"6.5",column:"population_6_5"},{display:"6",column:"population_6_0"},{display:"5.5",column:"population_5_5"},{display:"5",column:"population_5_0"},{display:"4.5",column:"population_4_5"},{display:"4",column:"population_4_0"},{display:"3.5",column:"population_3_5"},{display:"3",column:"population_3_0"},{display:"2.5",column:"population_2_5"},{display:"2",column:"population_2_0"},{display:"1.5",column:"population_1_5"},{display:"1",column:"population_1_0"},]);n.setSubgradeColumns([{display:"Centering",column:"centeringGrade",optional:!1,sortOrder:2,customSort:function(n){return parseFloat(n.centeringGrade)||-1}},{display:"Surface",column:"surfaceGrade",optional:!1,sortOrder:3},{display:"Corners",column:"cornersGrade",optional:!1,sortOrder:4},{display:"Edges",column:"edgesGrade",optional:!1,sortOrder:5},{display:"Total",column:"populationCount",optional:!1,sortOrder:6},])}])